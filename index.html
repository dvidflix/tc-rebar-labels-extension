<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trimble Connect API Test Extension</title>
  <script src="https://components.connect.trimble.com/trimble-connect-workspace-api/index.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    h1 { color: #1a5fb4; }
    button { padding: 10px 16px; margin: 10px 5px; background: #1a5fb4; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #144a8a; }
    pre { background: #eee; padding: 10px; border-radius: 4px; max-height: 400px; overflow: auto; }
    .status { margin: 10px 0; font-weight: bold; }
    .good { color: #008000; }
    .error { color: #d00000; }
  </style>
</head>
<body>
  <h1>Trimble Connect API Test Extension</h1>
  <div class="status" id="status">Initializing...</div>

  <button id="testConnection">Test Connection & Basic Info</button>
  <button id="testSelection">Test Current Selection (select something first!)</button>
  <button id="testAllObjects">Test Get All Objects (if supported)</button>

  <h3>Results:</h3>
  <pre id="output">No tests run yet.</pre>

  <script>
    let tcApi = null;

    async function init() {
      try {
        tcApi = await TrimbleConnectWorkspace.connect(window.parent);
        document.getElementById('status').textContent = 'Connected successfully!';
        document.getElementById('status').classList.add('good');
      } catch (err) {
        document.getElementById('status').textContent = 'Connection failed: ' + err.message;
        document.getElementById('status').classList.add('error');
        console.error(err);
      }
    }

    function log(message) {
      const output = document.getElementById('output');
      output.textContent += message + '\n';
      console.log(message);
    }

    async function testConnection() {
      document.getElementById('output').textContent = 'Running connection test...\n';
      if (!tcApi) {
        log('ERROR: Not connected. Reload the extension.');
        return;
      }

      log('Connection OK: tcApi object available.');

      // Basic viewer checks
      if (tcApi.viewer) {
        log('Viewer API available.');

        // Try getSelection (most reliable)
        try {
          const selection = await tcApi.viewer.getSelection();
          log(`Current selection: ${selection.length} items`);
          if (selection.length > 0) {
            log('Example selected item: ' + JSON.stringify(selection[0], null, 2));
          }
        } catch (e) {
          log('getSelection failed: ' + e.message);
        }

        // Try getObjects with no args
        try {
          const allObjs = await tcApi.viewer.getObjects();
          log(`getObjects() returned ${allObjs.length} objects (all loaded models)`);
        } catch (e) {
          log('getObjects() failed (may require modelId): ' + e.message);
        }

        // Try getLoadedModels if exists
        if (typeof tcApi.viewer.getLoadedModels === 'function') {
          try {
            const models = await tcApi.viewer.getLoadedModels();
            log(`Loaded models: ${models.length}`);
          } catch (e) {
            log('getLoadedModels failed: ' + e.message);
          }
        } else {
          log('getLoadedModels not available on viewer API.');
        }
      } else {
        log('No tcApi.viewer - not in 3D viewer context?');
      }

      // Test model properties on a selected object
      if (tcApi.model) {
        log('Model API available for properties.');
      }
    }

    async function testSelection() {
      document.getElementById('output').textContent = 'Testing selection...\n';
      if (!tcApi || !tcApi.viewer) {
        log('Not connected or no viewer.');
        return;
      }

      try {
        const selection = await tcApi.viewer.getSelection();
        log(`Selection has ${selection.length} objects.`);
        if (selection.length === 0) {
          log('Select one or more objects (e.g., a yellow rebar bar) in the 3D viewer first!');
          return;
        }

        for (let i = 0; i < Math.min(3, selection.length); i++) {
          const sel = selection[i];
          log(`Object ${i+1}: ID = ${sel.objectId || sel.id}`);

          try {
            const props = await tcApi.model.getProperties(sel.objectId || sel.id);
            log(`Properties fetched successfully (${Object.keys(props).length} properties):`);
            log(JSON.stringify(props, null, 2));
          } catch (propErr) {
            log(`Failed to get properties for this object: ${propErr.message}`);
          }
        }
      } catch (e) {
        log('Error getting selection: ' + e.message);
      }
    }

    async function testAllObjects() {
      document.getElementById('output').textContent = 'Trying to get all objects...\n';
      if (!tcApi || !tcApi.viewer) return;

      try {
        const objs = await tcApi.viewer.getObjects();
        log(`Success! getObjects() returned ${objs.length} objects from all loaded models.`);
        if (objs.length > 0) {
          log('First object example: ' + JSON.stringify(objs[0], null, 2));
        }
      } catch (e) {
        log('getObjects() failed: ' + e.message + ' (common if no models loaded or API requires modelId)');
      }
    }

    document.getElementById('testConnection').onclick = testConnection;
    document.getElementById('testSelection').onclick = testSelection;
    document.getElementById('testAllObjects').onclick = testAllObjects;

    init();
  </script>
</body>
</html>